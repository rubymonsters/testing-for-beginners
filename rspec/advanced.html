<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="Testing for Beginners">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="google-site-verification" content="BEd2YAbpSQrRqU2-5wUifTTzvqTMGLLE269b0JZTfCs" />

    <title>Advanced Usage | Testing for Beginners</title>

    <link href="../assets/stylesheets/monstas-fe625f69.css" rel="stylesheet" type="text/css" />
    <link rel="icon" type="image/png" href="/assets/images/favicon-870787d6.png" />
  </head>

  <body>
    <nav class="page-nav"><a class="prev" href="/rspec/format.html">
  Previous
</a></nav>
    <nav class="page-nav"><a class="next" href="/rspec/custom_matchers.html">
  Next
</a></nav>

    <div>
      <nav class="toc">
        <h1>Contents</h1>
        <ul>
  <li>
    <a href="/index.html">
      Testing For Beginners
    </a>
  </li>
  <li>
    <a href="/preface.html">
      Preface
    </a>
  </li>
  <li class="directory">
    <a href="/testing.html">
      Testing Code
    </a>
    <ul>
      <li>
        <a href="/testing/output.html">
          Testing via output
        </a>
      </li>
      <li>
        <a href="/testing/separation.html">
          Separating test code
        </a>
      </li>
      <li>
        <a href="/testing/computed.html">
          Computed tests
        </a>
      </li>
      <li>
        <a href="/testing/assert.html">
          Assertions
        </a>
      </li>
      <li>
        <a href="/testing/stages.html">
          Stages of a test
        </a>
      </li>
      <li>
        <a href="/testing/classes.html">
          Test Classes
        </a>
      </li>
    </ul>
  </li>
  <li>
    <a href="/libraries.html">
      Libraries
    </a>
  </li>
  <li>
    <a href="/minitest.html">
      Minitest
    </a>
  </li>
  <li class="directory expanded">
    <a href="/rspec.html">
      RSpec
    </a>
    <ul>
      <li>
        <a href="/rspec/basics.html">
          Basic Usage
        </a>
      </li>
      <li>
        <a href="/rspec/matchers.html">
          Matchers
        </a>
      </li>
      <li>
        <a href="/rspec/format.html">
          Format
        </a>
      </li>
      <li class="active">
        <a href="/rspec/advanced.html">
          Advanced Usage
        </a>
      </li>
      <li>
        <a href="/rspec/custom_matchers.html">
          Custom Matchers
        </a>
      </li>
      <li>
        <a href="/rspec/filtering.html">
          Filtering
        </a>
      </li>
    </ul>
  </li>
  <li class="directory">
    <a href="/rack_test.html">
      Rack::Test
    </a>
    <ul>
      <li>
        <a href="/rack_test/rack.html">
          Testing a Rack app
        </a>
      </li>
      <li>
        <a href="/rack_test/sinatra.html">
          Testing a Sinatra app
        </a>
      </li>
    </ul>
  </li>
  <li class="directory">
    <a href="/headless.html">
      Headless browsers
    </a>
    <ul>
      <li>
        <a href="/headless/phantomjs.html">
          Phantom.js
        </a>
      </li>
      <li>
        <a href="/headless/capybara.html">
          Capybara
        </a>
      </li>
      <li>
        <a href="/headless/features.html">
          Feature tests
        </a>
      </li>
    </ul>
  </li>
  <li>
    <a href="/test_doubles.html">
      Test doubles
    </a>
  </li>
  <li>
    <a href="/analysis.html">
      Code Analysis
    </a>
  </li>
  <li>
    <a href="/services.html">
      Services
    </a>
  </li>
</ul>
      </nav>
      <article>
        <nav class="menu"><a href="#"></a></nav>
        <h1>Advanced Usage</h1>

<p>RSpec comes with a lot of well-thought-out features that allow us to write very
descriptive, succinct, and concise tests that focus on the few things we really
care about.</p>

<p>So far, our tests, using the most basic style, look something like this:</p>
<pre class="highlight ruby"><code><span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="n">context</span> <span class="s2">"born in 2001"</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s2">"is not born in a leap year"</span> <span class="k">do</span>
      <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"Francisca"</span><span class="p">,</span> <span class="s2">"2001-01-01"</span><span class="p">)</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">user</span><span class="p">).</span><span class="nf">not_to</span> <span class="n">be_born_in_leap_year</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">context</span> <span class="s2">"born in 1900"</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s2">"is not born in a leap year"</span> <span class="k">do</span>
      <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"Francisca"</span><span class="p">,</span> <span class="s2">"1900-01-01"</span><span class="p">)</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">user</span><span class="p">).</span><span class="nf">not_to</span> <span class="n">be_born_in_leap_year</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">context</span> <span class="s2">"born in 2000"</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s2">"is born in a leap year"</span> <span class="k">do</span>
      <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"Francisca"</span><span class="p">,</span> <span class="s2">"2000-01-01"</span><span class="p">)</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">user</span><span class="p">).</span><span class="nf">to</span> <span class="n">be_born_in_leap_year</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">context</span> <span class="s2">"born in 2004"</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s2">"is born in a leap year"</span> <span class="k">do</span>
      <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"Francisca"</span><span class="p">,</span> <span class="s2">"2004-01-01"</span><span class="p">)</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">user</span><span class="p">).</span><span class="nf">to</span> <span class="n">be_born_in_leap_year</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>As you see we keep repeating the setup in the first line of every test.
Wouldn&rsquo;t it be nice to move this to a shared place, like Minitest&rsquo;s <code>setup</code>
method?</p>

<h2>Before</h2>

<p>RSpec has the same feature, but it calls it <code>before</code>.</p>

<p>This is just another method that RSpec defines, and it takes a block, too.
RSpec will call (execute) this block before each one of the tests (examples):</p>
<pre class="highlight ruby"><code><span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"Francisca"</span><span class="p">,</span> <span class="s2">"2001-01-01"</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">context</span> <span class="s2">"born in 2001"</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s2">"is not born in a leap year"</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="vi">@user</span><span class="p">).</span><span class="nf">not_to</span> <span class="n">be_born_in_leap_year</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">context</span> <span class="s2">"born in 2000"</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s2">"is born in a leap year"</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="vi">@user</span><span class="p">).</span><span class="nf">to</span> <span class="n">be_born_in_leap_year</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>Our <code>before</code> block sets up an instance variable <code>@user</code> so that our test then
can use it. That&rsquo;s cool.</p>

<p>However, we now have a problem: The hard-coded birthday is specific to the first
context, and should be different for each one of our contexts, because that&rsquo;s
the one single piece of data that changes. The second test would use the wrong
year, and therefore fail, because it would use a user that is actually born in
<code>2000</code>, not <code>2001</code>, despite what the context desciption tells.</p>

<p>So how do we fix that?</p>

<h2>Let</h2>

<p>RSpec comes with another feature to help with this: the method <code>let</code> allows us
to define such bits of data (or more precisely, objects) that need to be
specified per context. Here&rsquo;s how that looks like:</p>
<pre class="highlight ruby"><code><span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="n">before</span> <span class="p">{</span> <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"Francisca"</span><span class="p">,</span> <span class="s2">"</span><span class="si">#{</span><span class="n">year</span><span class="si">}</span><span class="s2">-01-01"</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">context</span> <span class="s2">"born in 2001"</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:year</span><span class="p">)</span> <span class="p">{</span> <span class="mi">2001</span> <span class="p">}</span>

    <span class="n">it</span> <span class="s2">"is not born in a leap year"</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="vi">@user</span><span class="p">).</span><span class="nf">not_to</span> <span class="n">be_born_in_leap_year</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">context</span> <span class="s2">"born in 2000"</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:year</span><span class="p">)</span> <span class="p">{</span> <span class="mi">2000</span> <span class="p">}</span>

    <span class="n">it</span> <span class="s2">"is born in a leap year"</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="vi">@user</span><span class="p">).</span><span class="nf">to</span> <span class="n">be_born_in_leap_year</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>This fixes our problem, and these tests pass.</p>

<p>Essentially, <code>let</code> is a method that defines another method with the given name,
in our case <code>year</code>. This method then can be used in other places, such as the
<code>before</code> block, or our tests (<code>it</code> blocks).</p>

<p>Instead of using the rather generic <code>before</code> block, and instance variables, we
can also use <code>let</code> to setup the user:</p>
<pre class="highlight ruby"><code><span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span> <span class="p">{</span> <span class="no">User</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"Francisca"</span><span class="p">,</span> <span class="s2">"</span><span class="si">#{</span><span class="n">year</span><span class="si">}</span><span class="s2">-01-01"</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">context</span> <span class="s2">"born in 2001"</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:year</span><span class="p">)</span> <span class="p">{</span> <span class="mi">2001</span> <span class="p">}</span>

    <span class="n">it</span> <span class="s2">"is not born in a leap year"</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">user</span><span class="p">).</span><span class="nf">not_to</span> <span class="n">be_born_in_leap_year</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">context</span> <span class="s2">"born in 2000"</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:year</span><span class="p">)</span> <span class="p">{</span> <span class="mi">2000</span> <span class="p">}</span>

    <span class="n">it</span> <span class="s2">"is born in a leap year"</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">user</span><span class="p">).</span><span class="nf">to</span> <span class="n">be_born_in_leap_year</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>This actually is a pretty common way of writing RSpec tests.</p>

<p>The <code>let(:user)</code> statement defines the <code>user</code>, and as you can see, this
statement is common to both contexts: they both use <code>user</code>.</p>

<p>The <code>let(:year)</code> statements however, are specific to the contexts, and define
the <code>year</code> for each one of the contexts.</p>

<h2>Subject and Should</h2>

<p>Now <code>user</code> is the object under test, and it is an instance of the class <code>User</code>
which is already mentioned in the <code>describe</code> statement. So, in a way, this is
a little repetitive.</p>

<p>Because this is such a common pattern, RSpec comes with another feature to make
this a little more concise, and remove this repetition: <code>subject</code>. We can use
it like so:</p>
<pre class="highlight ruby"><code><span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="n">subject</span> <span class="p">{</span> <span class="no">User</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"Francisca"</span><span class="p">,</span> <span class="s2">"</span><span class="si">#{</span><span class="n">year</span><span class="si">}</span><span class="s2">-01-01"</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">context</span> <span class="s2">"born in 2000"</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:year</span><span class="p">)</span> <span class="p">{</span> <span class="mi">2000</span> <span class="p">}</span>

    <span class="n">it</span> <span class="s2">"is born in a leap year"</span> <span class="k">do</span>
      <span class="n">expect</span><span class="p">(</span><span class="n">subject</span><span class="p">).</span><span class="nf">to</span> <span class="n">be_born_in_leap_year</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>And because <code>subject</code>, semantically, is the thing we want to test, RSpec also
defines a shorthand for <code>expect(subject).to</code> that we can use if we have a
<code>subject</code> defined: <code>should</code>. That makes our code even more concise:</p>
<pre class="highlight ruby"><code><span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="n">subject</span> <span class="p">{</span> <span class="no">User</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"Francisca"</span><span class="p">,</span> <span class="s2">"</span><span class="si">#{</span><span class="n">year</span><span class="si">}</span><span class="s2">-01-01"</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">context</span> <span class="s2">"born in 2000"</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:year</span><span class="p">)</span> <span class="p">{</span> <span class="mi">2000</span> <span class="p">}</span>

    <span class="n">it</span> <span class="s2">"is born in a leap year"</span> <span class="k">do</span>
      <span class="n">should</span> <span class="n">be_born_in_leap_year</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>This works great. And we&rsquo;ve reduced the amount of code we have to type by
a great deal.</p>

<p>However, what&rsquo;s with the duplication in the <code>it</code> message, and the actual code
that implements our expectation?</p>

<h2>Anonymous it</h2>

<p>The lines <code>it &quot;is born in a leap year&quot;</code> and <code>should be_born_in_leap_year</code>
pretty much describe the same thing, don&rsquo;t they?</p>

<p>RSpec allows us to omit the message passed to <code>it</code> and simply put the
whole test on one line, like so:</p>
<pre class="highlight ruby"><code><span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="n">subject</span> <span class="p">{</span> <span class="no">User</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"Francisca"</span><span class="p">,</span> <span class="s2">"</span><span class="si">#{</span><span class="n">year</span><span class="si">}</span><span class="s2">-01-01"</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">context</span> <span class="s2">"born in 2000"</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:year</span><span class="p">)</span> <span class="p">{</span> <span class="mi">2000</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_born_in_leap_year</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>Whoa.</p>

<p>Let&rsquo;s apply this to all of our tests.</p>

<p>We can implement the same test case we&rsquo;ve had before (at the beginning of this
chapter) like this, using all the advanced features we&rsquo;ve just learned:</p>
<pre class="highlight ruby"><code><span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="n">subject</span> <span class="p">{</span> <span class="no">User</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"Francisca"</span><span class="p">,</span> <span class="s2">"</span><span class="si">#{</span><span class="n">year</span><span class="si">}</span><span class="s2">-01-01"</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">context</span> <span class="s2">"born in 2001"</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:year</span><span class="p">)</span> <span class="p">{</span> <span class="mi">2001</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_born_in_leap_year</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">context</span> <span class="s2">"born in 1900"</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:year</span><span class="p">)</span> <span class="p">{</span> <span class="mi">1900</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should_not</span> <span class="n">be_born_in_leap_year</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">context</span> <span class="s2">"born in 2000"</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:year</span><span class="p">)</span> <span class="p">{</span> <span class="mi">2000</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_born_in_leap_year</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">context</span> <span class="s2">"born in 2004"</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:year</span><span class="p">)</span> <span class="p">{</span> <span class="mi">2004</span> <span class="p">}</span>
    <span class="n">it</span> <span class="p">{</span> <span class="n">should</span> <span class="n">be_born_in_leap_year</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>

<p>You decide which one you like better.</p>

<p>The output will look a wee bit different, but just as readable, even though we
haven&rsquo;t written out the extra description on the <code>it</code> block:</p>
<pre class="highlight plaintext"><code>$ rspec --format doc user_spec.rb

User
  born in 2001
    should not be born in leap year
  born in 1900
    should not be born in leap year
  born in 2000
    should be born in leap year
  born in 2004
    should be born in leap year

Finished in 0.00462 seconds (files took 0.1464 seconds to load)
4 examples, 0 failures
</code></pre>

<p>To summarize, the extra features used are:</p>

<ul>
<li><code>let</code> allows you to dynamically define a method that will return the given
value. We use this to define the only varying bit of data: the <code>year</code>.
It is important to note that <code>let</code> memoizes the result. I.e. it only calls
the block once. Also, it only executes the block when you actually call it.</li>
<li><code>subject</code> is a convenience helper that lets us specify the &ldquo;thing&rdquo; that
is under test. In our case that&rsquo;s a <code>User</code> instance. <code>subject</code> also memoizes
the result. And just like <code>let</code>, it also only executes the block when you
actually call it.</li>
<li><code>should</code> assumes that we want to test the <code>subject</code>. It is a shorthand for
<code>expect(subject).to</code> (while <code>should_not</code> is the corresponding shorthand for
<code>expect(subject).not_to</code>).</li>
</ul>

<p>This style lets us reduce the amount of code that we need to type (and read)
significantly.</p>

<p>The first version (&ldquo;basic style&rdquo;) of our tests had 715 characters on 29 lines.
This new version has 474 characters on 23 lines. That&rsquo;s a massive reduction
(~30% less characters to type and read), and allows us to focus much more on
the relevant differences.</p>

<p>However, it also requires for us to learn these RSpec features, and get
familiar with how to implement and understand such tests properly.</p>

        <nav class="page-nav"><a class="prev" href="/rspec/format.html">
  Previous
</a></nav>
        <nav class="page-nav"><a class="next" href="/rspec/custom_matchers.html">
  Next
</a></nav>
      </article>
    </div>

    <footer>
      <ul>
        <li><a href="http://rubymonstas.org">Ruby Monstas</a></li>
        <li><a href="http://ruby-for-beginners.rubymonstas.org">Ruby For Beginners</a></li>
        <li><a href="http://webapps-for-beginners.rubymonstas.org">Webapps For Beginners</a></li>
        <li><a href="http://testing-for-beginners.rubymonstas.org">Testing For Beginners</a></li>
        <li><a href="mailto:ruby.monsters@gmail.com">Email</a></li>
        <li><a href="https://twitter.com/rubymonsters">Twitter</a></li>
        <li><a href="https://github.com/rubymonsters">GitHub</a></li>
        <li><a href="https://creativecommons.org/licenses/by-sa/2.0/" rel="license cc:license">License</a></li>
        <li><a href="http://foundation.travis-ci.org/imprint/">Imprint</a></li>
      </ul>
    </footer>

    <script src="../assets/javascripts/modernizr-4c875d94.js" type="text/javascript"></script>
    <script src="../assets/javascripts/monstas-79961449.js" type="text/javascript"></script>
  </body>
</html>
